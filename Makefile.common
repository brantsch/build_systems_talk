LISTINGS := $(notdir ${LSTINPUT})
LISTINGS := $(addsuffix .tex,${LISTINGS})
LISTINGS := $(addprefix listings/,${LISTINGS})

# first target is default target: compile our document
all: ${DOC}.${TCTARGET}

${DOC}.${TCTARGET}: parts/*.tex ../build_systems.bib ${LISTINGS}

# macro defining how .tex files should be compiled
define compiletex
	${TC} $<
endef

# pattern rule for compilation of .tex to target format
%.${TCTARGET}: %.tex pygments_style.tex %.bbl %.toc 
	${compiletex}

%.bbl %.blg: %.aux
	bibtex $<

listings:
	mkdir listings

EXPENDABLES += pygments_style.tex
.INTERMEDIATE: pygments_style.tex
pygments_style.tex: ;
	pygmentize -f latex -S ${PYGMENTS_STYLE} > $@

# macro for highlighting of Makefile source code
define highlightmakefile
	pygmentize -l make -f latex -o listings/$(notdir ${1}).tex ${1};
endef

#listings/%.tex: %
#	$(call highlightmakefile,$<)

${LISTINGS}:: listings

${LISTINGS}:: ${LSTINPUT} 
	$(foreach SRCFILE,$?,$(call highlightmakefile,${SRCFILE}))

# pattern rule for generation of .toc files
%.aux: %.tex
	${compiletex}

%.toc: %.tex
	${compiletex}

# this would prevent make from deleting intermediate files, but I've had to
# comment it out, because the files in question are:
# 	* dependencies of the final document
# 	* generated by LaTeX in _every_ run.
# Thus, the document would be rebuilt unnecessarily often if these intermediate
# files were preserved.
#
#.SECONDARY: ; 

# auxiliary targets
.PHONY: clean squeaky_clean view edit

clean:
	-rm -rf ${EXPENDABLES}

squeaky_clean: EXPENDABLES+=${DOC}.${TCTARGET}
squeaky_clean: clean

view: ${DOC}.${TCTARGET}
	${VIEWER} $< &

edit:
	gvim -p ${DOC}.tex parts/*.tex Makefile
